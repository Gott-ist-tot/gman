# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

gman is a Git repository management CLI tool built in Go. It allows developers to manage multiple Git repositories efficiently with features like status checking, quick switching, batch operations, and shell integration.

## Development Commands

### Building and Running
- `make build` - Build the gman binary
- `make run` - Build and run the binary
- `go build -o gman .` - Direct Go build command

### Testing and Quality
- `make test` or `go test ./...` - Run all tests
- `make lint` - Run golangci-lint (requires golangci-lint to be installed)
- `make fmt` - Format code with go fmt

#### Test Coverage Strategy
The project maintains comprehensive test coverage across multiple layers:

**Unit Tests:**
- `internal/git/git_test.go` - Git operations, diff functionality, worktree management
- `internal/interactive/selector_test.go` - Interactive selection components
- `internal/index/indexer_test.go` - Search indexing system and SQLite operations
- `pkg/types/` - Type definitions and validation

**Command Tests:**
- `cmd/diff_test.go` - File comparison commands (branch diff, cross-repo diff)
- `cmd/worktree_test.go` - Worktree lifecycle management
- `cmd/switch_test.go` - Enhanced switch functionality with worktree integration

**Integration Tests:**
- `test/integration_test.go` - Cross-package functionality
- `test/helpers.go` - Shared test utilities and mock repositories

**Test Categories:**
- **Git Integration Tests** - Real Git operations with temporary repositories
- **Command Line Tests** - End-to-end command execution and output validation
- **Interactive Component Tests** - Simulated user input and menu navigation
- **Error Handling Tests** - Edge cases, invalid inputs, and failure recovery
- **Concurrent Operation Tests** - Multi-repository parallel operations

### Cross-platform Building
- `make build-all` - Build for multiple platforms (Linux, macOS, Windows)
- `make clean` - Clean build artifacts

### Installation
- `make install` - Install binary to /usr/local/bin (requires sudo)
- `./scripts/install.sh` - Installation script for end users

## Architecture

### Core Components

**Command Structure (cmd/)**
- Uses Cobra CLI framework for command handling
- Each command is in its own file (add.go, list.go, status.go, recent.go, group.go, branch.go, batch.go, find.go, index.go, etc.)
- Root command in `cmd/root.go` handles global configuration and initialization
- Enhanced commands: `recent` for recently accessed repositories, `group` for repository group management
- Advanced Git workflow commands: `branch` for cross-repository branch management, batch operations (`commit`, `push`, `stash`), `diff` for file comparison across branches and repositories, `worktree` for Git worktree management
- **Phase 5.0 Search Commands**: `find` for fzf-powered file and commit searching, `index` for search index management
- Extended sync command with conditional options, dry-run mode, and progress display

**Configuration Management (internal/config/)**
- `config.go` handles YAML-based configuration at `~/.config/gman/config.yml`
- Manages repository mappings, user settings, recent usage tracking, and repository groups
- Direct YAML parsing for full feature support (recent usage, groups, extended settings)
- Methods: TrackRecentUsage(), CreateGroup(), DeleteGroup(), GetGroupRepositories(), AddToGroup(), RemoveFromGroup()

**Interactive Package (internal/interactive/)**
- `selector.go` provides interactive repository selection
- Fuzzy matching capabilities for repository aliases
- User-friendly numbered selection interface

**Git Operations (internal/git/)**
- Handles all Git-specific operations like status checking and sync
- Supports concurrent operations across multiple repositories with semaphore-based concurrency control
- Extended status information: file change counts, commit timestamps
- Repository filtering for conditional sync operations
- Cross-repository branch management: GetBranches(), CreateBranch(), SwitchBranch(), CleanMergedBranches()
- Batch Git operations: CommitChanges(), PushChanges(), StashSave(), StashPop(), StashList(), StashClear()
- Utility methods: HasUncommittedChanges(), HasUnpushedCommits(), detectMainBranch()

**Progress Tracking (internal/progress/)**
- `progress.go` provides real-time progress tracking for concurrent operations
- MultiBar system for tracking multiple repository operations simultaneously
- Individual progress bars with ETA calculations and duration formatting
- OperationStatus tracking for pending, running, completed, and failed operations

**Display Layer (internal/display/)**
- Manages colorized table output with flexible column layouts
- Formats repository status with visual indicators (üü¢üî¥üü° for workspace status, ‚úÖ‚Üë‚ÜìüîÑ for sync status)
- Extended display mode showing file changes and commit times
- NewExtendedStatusDisplayer() for detailed information display

**Shared Types (pkg/types/)**
- Core data structures: Config, RepoStatus, WorkspaceStatus, SyncStatus, RecentEntry, Group
- Extended RepoStatus with FilesChanged and CommitTime fields
- RecentEntry for tracking repository access history with timestamps
- Group type for organizing repositories with metadata (name, description, creation time)
- Enums with String() methods for display formatting

### Key Features Implementation

**Shell Integration**: The tool outputs special `GMAN_CD:` prefix for directory changes that the shell wrapper function processes to actually change directories.

**Interactive Commands**: 
- `gman switch` without arguments shows an interactive selection menu
- Fuzzy matching allows partial repository name matching (e.g., `gman switch cli` matches `cli-tool`)
- Recent usage tracking automatically records and displays recently accessed repositories

**Enhanced Status Display**:
- Standard mode: `gman status` shows basic repository information
- Extended mode: `gman status --extended` includes file change counts and commit timestamps
- Human-readable time formatting (19m, 2h, 3d, etc.)

**Recent Usage Tracking**:
- `gman recent` command shows recently accessed repositories with timestamps
- Automatic tracking when switching between repositories
- Maintains last 10 accessed repositories with access times

**Batch Operations & Conditional Sync**:
- Conditional sync flags: `--only-dirty`, `--only-behind`, `--only-ahead` for selective repository synchronization
- `--dry-run` mode for previewing sync operations without execution
- `--progress` flag for real-time progress tracking with concurrent operation status
- Repository filtering logic based on workspace and sync status

**Repository Grouping**:
- `gman group create <name> <repos...>` - Create repository groups with optional descriptions
- `gman group list` - Display all configured groups with metadata and repository counts
- `gman group delete <name>` - Remove repository groups
- `gman group add/remove <name> <repos...>` - Modify group membership
- `gman sync --group <name>` - Sync only repositories in specific groups
- YAML configuration storage with timestamps and descriptions

**Concurrent Operations**: Uses Go's concurrency with semaphore-based parallelism for repository operations (default 5 parallel jobs).

**Configuration**: YAML-based with defaults, supports repository aliases, custom sync modes (ff-only, rebase, autostash), recent usage history, and repository groups.

## Dependencies

Key external libraries:
- `github.com/spf13/cobra` - CLI framework
- `github.com/spf13/viper` - Configuration management  
- `github.com/fatih/color` - Colorized output
- `github.com/olekukonko/tablewriter` - Table formatting
- `gopkg.in/yaml.v3` - YAML parsing

## Testing Strategy

The project uses Go's built-in testing framework. Run tests before submitting changes to ensure functionality remains intact across the concurrent Git operations and configuration management.

## Recent Enhancements

All Phase 1 and Phase 2 features have been successfully implemented:

### Phase 1 - Interactive Experience ‚úÖ
- **Interactive Repository Selection**: Enhanced `gman switch` command with fuzzy matching and interactive selection
- **Recent Usage Tracking**: Automatic tracking of repository access with `gman recent` command
- **Enhanced Status Display**: Extended status mode with file change counts and commit timestamps

### Phase 2 - Batch Operations ‚úÖ  
- **Conditional Sync Options**: Implemented selective synchronization flags (`--only-dirty`, `--only-behind`, `--only-ahead`)
- **Dry-Run Mode**: Added preview functionality with `--dry-run` flag for safe operation verification
- **Progress Display**: Real-time progress tracking with `--progress` flag and MultiBar system
- **Repository Grouping**: Complete group management system with create, list, delete, add, and remove operations

### Phase 3.1 - Git Â∑•‰ΩúÊµÅÁ®ãÊ∑±Â∫¶Êï¥Âêà ‚úÖ
- **Cross-Repository Branch Management**: Complete branch operations across all repositories
  - `gman branch list [--verbose] [--remote]` - Display branch status across repositories
  - `gman branch create <name>` - Create branches in multiple repositories
  - `gman branch switch <name>` - Switch branches across repositories
  - `gman branch clean [--main <branch>]` - Clean merged branches automatically
- **Batch Git Operations**: Unified Git operations with group support and progress tracking
  - `gman commit -m "message" [--add] [--group <name>]` - Cross-repository commits
  - `gman push [--force] [--set-upstream] [--group <name>]` - Batch push operations
  - `gman stash [save|pop|list|clear] [--group <name>]` - Cross-repository stash management
- **Enhanced Group Integration**: All new commands support group filtering and dry-run modes
- **File Comparison & Diff Operations**: Advanced file comparison capabilities across branches and repositories
  - `gman diff file <repo> <branch1> <branch2> -- <file_path>` - Compare files between branches within a repository
  - `gman diff cross-repo <repo1> <repo2> -- <file_path>` - Compare files between different repositories
  - `--tool <external_tool>` support for visual diff tools (meld, vimdiff, etc.)
- **Git Worktree Management**: Native Git worktree integration for parallel development
  - `gman worktree add <repo> <path> --branch <branch>` - Create worktrees for parallel feature development
  - `gman worktree list <repo>` - Display all worktrees with branch and status information
  - `gman worktree remove <repo> <path> [--force]` - Clean removal of completed worktrees
  - **Seamless Switch Integration**: Worktrees appear as first-class targets in `gman switch` interactive menu

These enhancements significantly improve batch operation efficiency and provide advanced Git workflow management across multiple repositories.

### Phase 5.0 - ‰∫íÂãïÈ´îÈ©óÈáçÂ°ëÔºöfzf Ê∑±Â∫¶Êï¥Âêà ‚úÖ
- **SQLite Á¥¢ÂºïÁ≥ªÁµ±**: È´òÊïàÁöÑÂÖ®ÊñáÊêúÁ¥¢Á¥¢ÂºïÔºåÊîØÊè¥Êñá‰ª∂ÂíåÊèê‰∫§ÊêúÁ¥¢
- **Ê∑±Â∫¶ fzf Êï¥Âêà**: ÁÑ°Á∏´ÁöÑÊ®°Á≥äÊêúÁ¥¢È´îÈ©óÔºåË∑®ÂÄâÂ∫´Êñá‰ª∂ÂíåÊèê‰∫§ÊêúÁ¥¢
- **Êô∫ËÉΩÈ†êË¶ΩÂäüËÉΩ**: Âç≥ÊôÇÁöÑÊñá‰ª∂ÂÖßÂÆπÂíåÊèê‰∫§Â∑ÆÁï∞È†êË¶Ω
- **Á¥¢ÂºïÁÆ°ÁêÜÂëΩ‰ª§**: ÂÆåÊï¥ÁöÑÁ¥¢ÂºïÁîüÂëΩÈÄ±ÊúüÁÆ°ÁêÜ (`gman index rebuild/update/stats/clear`)
  - `gman find file [pattern] [--group <name>]` - Ë∑®ÂÄâÂ∫´Êñá‰ª∂ÊêúÁ¥¢
  - `gman find commit [pattern] [--group <name>]` - Ë∑®ÂÄâÂ∫´Êèê‰∫§ÊêúÁ¥¢

### Phase 5.2 - TUI DashboardÔºöÁµ±‰∏ÄÁÆ°ÁêÜÁïåÈù¢ ‚úÖ
- **Bubble Tea TUI Ê°ÜÊû∂**: Áèæ‰ª£ÂåñÁöÑÁµÇÁ´ØÁî®Êà∂ÁïåÈù¢
- **ÂõõÈù¢ÊùøÂÑÄË°®Êùø**: Repository/Status/Search/Preview Áµ±‰∏ÄÂ∏ÉÂ±Ä
- **Âç≥ÊôÇÁãÄÊÖãÁõ£Êéß**: ÂØ¶ÊôÇÂÄâÂ∫´ÁãÄÊÖãÊõ¥Êñ∞ÂíåË¶ñË¶∫ÊåáÁ§∫
- **ÈçµÁõ§Â∞éËà™Á≥ªÁµ±**: ÂÆåÊï¥ÁöÑÂø´Êç∑ÈçµÊîØÊåÅÂíå Vim È¢®Ê†ºÂ∞éËà™
- **‰∏ªÈ°åÁ≥ªÁµ±**: ÊîØÊè¥ Dark/Light ‰∏ªÈ°åÂàáÊèõ
- **ÁÑ°Á∏´Êï¥Âêà**: Ëàá Phase 5.1 ÊêúÁ¥¢ÂäüËÉΩÂíåÊâÄÊúâÁèæÊúâ CLI ÂëΩ‰ª§ÂÆåÁæéÊï¥Âêà
- **Êô∫ËÉΩÁµÇÁ´ØÊ™¢Ê∏¨**: Â¢ûÂº∑ÁöÑÁµÇÁ´ØÁõ∏ÂÆπÊÄßÊ™¢Ê∏¨ÂíåË®∫Êñ∑Á≥ªÁµ±
  - `gman dashboard` - ÂïüÂãï TUI ÂÑÄË°®Êùø
  - `gman dash/tui/ui` - ÂëΩ‰ª§Âà•ÂêçÊîØÊåÅ
  - `gman dashboard --debug` - È°ØÁ§∫ÁµÇÁ´ØË®∫Êñ∑Ë≥áË®ä
  - `gman dashboard --force` - Âº∑Âà∂ÂïüÂãï TUI Ê®°Âºè

## Future Roadmap - Êú™‰æÜÂäüËÉΩË¶èÂäÉ

### üîß **Êô∫ËÉΩÂÄâÂ∫´ÁÆ°ÁêÜ** (Êú™‰æÜËÄÉÊÖÆ)
- `gman discover <path>` - Ëá™ÂãïÁôºÁèæ‰∏¶Ê∑ªÂä†ÊåáÂÆöË∑ØÂæë‰∏ãÁöÑ Git ÂÄâÂ∫´
- `gman clone <url> [alias]` - ÂÖãÈöÜÈÅ†Á®ãÂÄâÂ∫´‰∏¶Ëá™ÂãïÊ∑ªÂä†Âà∞ÈÖçÁΩÆ
- `gman import <config-file>` - ÂæûÂÖ∂‰ªñÂ∑•ÂÖ∑ÊàñÊ†ºÂºèÂ∞éÂÖ•ÂÄâÂ∫´ÈÖçÁΩÆ

### üîß **ÊêúÁ¥¢ËàáÂàÜÊûêÂäüËÉΩ** (Êú™‰æÜËÄÉÊÖÆ)
- `gman search <pattern> [--type file|content]` - Ë∑®ÂÄâÂ∫´ÂÖßÂÆπÂíåÊñá‰ª∂ÊêúÁ¥¢
- `gman find <filename>` - Ë∑®ÂÄâÂ∫´Êñá‰ª∂Âø´ÈÄüÊü•Êâæ
- `gman analytics [--group <name>]` - ÂÄâÂ∫´Ê¥ªÂãïÂàÜÊûê„ÄÅÊèê‰∫§Áµ±Ë®à„ÄÅÊ¥ªË∫çÂ∫¶Â†±Âëä

### üîß **ÂÄâÂ∫´ÂÅ•Â∫∑ËàáÁ∂≠Ë≠∑** (Êú™‰æÜËÄÉÊÖÆ)
- `gman health [--detailed]` - Ê™¢Êü•ÂÄâÂ∫´ÁãÄÊÖã„ÄÅÂ§ßÊñá‰ª∂„ÄÅÊΩõÂú®ÂïèÈ°å
- `gman cleanup [--aggressive]` - Ëá™ÂãïÊ∏ÖÁêÜÂíåÂÑ™ÂåñÂÄâÂ∫´ (git gc, Ê∏ÖÁêÜÂàÜÊîØÁ≠â)
- `gman backup <destination>` - ÊâπÈáèÂÇô‰ªΩÂÄâÂ∫´Âà∞ÊåáÂÆö‰ΩçÁΩÆ

### üîß **Áí∞Â¢ÉÁÆ°ÁêÜÁ≥ªÁµ±** (Êú™‰æÜËÄÉÊÖÆ)
- `gman env create <name>` - ÂâµÂª∫Áí∞Â¢ÉÈÖçÁΩÆ (dev/staging/prod)
- `gman env switch <name>` - ÂàáÊèõÂà∞ÊåáÂÆöÁí∞Â¢ÉÁöÑÂÄâÂ∫´ÈõÜÂêà
- `gman env list` - ÂàóÂá∫ÊâÄÊúâÁí∞Â¢ÉÈÖçÁΩÆ
- `gman env sync <name>` - ÂêåÊ≠•ÁâπÂÆöÁí∞Â¢ÉÁöÑÊâÄÊúâÂÄâÂ∫´

### üí° **È´òÁ¥öÊï¥ÂêàÂäüËÉΩ** (Êú™‰æÜËÄÉÊÖÆ)
- GitHub/GitLab API Êï¥ÂêàÔºöÈ°ØÁ§∫ Pull Request„ÄÅMerge Request ÁãÄÊÖã
- CI/CD ÁÆ°ÈÅìÁãÄÊÖãÁõ£ÊéßÂíåÈ°ØÁ§∫
- Issue tracking Á≥ªÁµ±Êï¥Âêà
- ÈÖçÁΩÆÁÆ°ÁêÜÂ¢ûÂº∑ (`export/import`)
- È†ÖÁõÆÊ®°ÊùøÁ≥ªÁµ±ÂíåÊèí‰ª∂Êû∂Êßã

### üìà **È†ÖÁõÆÁãÄÊÖã**

gman ÁèæÂ∑≤Êèê‰æõÂÆåÊï¥ÁöÑÂ§öÂÄâÂ∫´ÁÆ°ÁêÜÂäüËÉΩÔºåÂåÖÊã¨Ôºö
- **ÂÆåÊï¥ÁöÑÂÄâÂ∫´ÁãÄÊÖãÁÆ°ÁêÜ** (Phase 1)
- **È´òÁ¥öÊâπÈáèÊìç‰ΩúÂíåÁæ§ÁµÑÁÆ°ÁêÜ** (Phase 2)  
- **Ê∑±Â∫¶ Git Â∑•‰ΩúÊµÅÁ®ãÊï¥Âêà** (Phase 3.1)
- **Êô∫ËÉΩÊêúÁ¥¢ÂíåÁ¥¢ÂºïÁ≥ªÁµ±** (Phase 5.0)
- **Áµ±‰∏Ä TUI ÁÆ°ÁêÜÁïåÈù¢** (Phase 5.2)

ÈÄô‰∫õÂäüËÉΩË∂≥‰ª•ÊªøË∂≥Â§ßÂ§öÊï∏Â§öÂÄâÂ∫´ÈñãÁôºÂ†¥ÊôØÁöÑÈúÄÊ±Ç„ÄÇÊú™‰æÜÂäüËÉΩÂ∞áÊ†πÊìöÁî®Êà∂ÂèçÈ•ãÂíåÂØ¶ÈöõÈúÄÊ±ÇÈÄ≤Ë°åË¶èÂäÉ„ÄÇ

## Â∏∏Ë¶ãÂïèÈ°åËàáËß£Ê±∫ÊñπÊ°à (Common Issues and Solutions)

### üö® gman switch ÁÑ°Ê≥ïÂàáÊèõÁõÆÈåÑÂïèÈ°å

**ÂïèÈ°åÊèèËø∞**: Âü∑Ë°å `gman switch <repo>` ÂæåÁúãÂà∞ `GMAN_CD:/path/to/repo` Ëº∏Âá∫Ôºå‰ΩÜÁï∂ÂâçÁõÆÈåÑÊ≤íÊúâÊîπËÆä„ÄÇ

**ÊäÄË°ìÂéüÁêÜ**: 
- Go Á®ãÂ∫è‰ΩúÁÇ∫Â≠êÈÄ≤Á®ãÈÅãË°åÔºåÂèóÂà∞Êìç‰ΩúÁ≥ªÁµ±ÈÄ≤Á®ãÈöîÈõ¢Ê©üÂà∂ÈôêÂà∂
- Â≠êÈÄ≤Á®ãÁÑ°Ê≥ï‰øÆÊîπÁà∂ shell ÁöÑÂ∑•‰ΩúÁõÆÈåÑÁãÄÊÖãÔºàÈÄôÊòØÂÆâÂÖ®Ë®≠Ë®àÔºâ
- `os.Chdir()` Âè™ÂΩ±Èüø Go Á®ãÂ∫èÊú¨Ë∫´Ôºå‰∏çÂΩ±ÈüøË™øÁî®ÂÆÉÁöÑ shell

**Ëß£Ê±∫ÊñπÊ°à**: ÂøÖÈ†àÂÆâË£ù shell ÂåÖË£ùÂáΩÊï∏‰æÜËôïÁêÜ `GMAN_CD:` Ëº∏Âá∫

**Ë®∫Êñ∑Ê≠•È©ü**:
1. **Ê™¢Êü• gman ÊòØÂê¶Âú® PATH ‰∏≠**:
   ```bash
   which gman  # ÊáâË©≤È°ØÁ§∫ gman ‰∫åÈÄ≤Âà∂Êñá‰ª∂Ë∑ØÂæë
   ```

2. **Ê™¢Êü• shell ÂáΩÊï∏ÊòØÂê¶Â∑≤Âä†Ëºâ**:
   ```bash
   type gman   # ÊáâË©≤È°ØÁ§∫ "gman is a function"
   ```

3. **Ê™¢Êü• shell ÈÖçÁΩÆ**:
   ```bash
   grep -n "gman" ~/.zshrc  # Ê™¢Êü•ÈÖçÁΩÆÊòØÂê¶Â≠òÂú®
   ```

**ÂÆåÊï¥ÈÖçÁΩÆÁ§∫‰æã** (Ê∑ªÂä†Âà∞ `~/.zshrc` Êàñ `~/.bashrc`):
```bash
# gman Git Repository Manager - Shell Integration
export PATH="/path/to/gman/directory:$PATH"

# gman wrapper function for directory switching
gman() {
    local output
    local exit_code

    # Call the actual gman binary and capture both output and exit code
    output=$(command gman "$@" 2>&1)
    exit_code=$?

    # Check if this is a directory change request
    if [[ "$output" == GMAN_CD:* ]]; then
        local target_dir="${output#GMAN_CD:}"
        if [ -d "$target_dir" ]; then
            cd "$target_dir"
            echo "Switched to: $target_dir"
        else
            echo "Error: Directory not found: $target_dir" >&2
            return 1
        fi
    else
        # For all other commands, just print the output
        echo "$output"
    fi

    return $exit_code
}

# Enable gman completion if available
if command -v gman &> /dev/null; then
    eval "$(gman completion zsh)"  # Êàñ bash
fi
```

**Ê∏¨Ë©¶È©óË≠â**:
```bash
# ÈáçÊñ∞Âä†ËºâÈÖçÁΩÆ
source ~/.zshrc

# Ê∏¨Ë©¶ÂäüËÉΩ
gman switch <repo-alias>
pwd  # ÊáâË©≤È°ØÁ§∫ÂàáÊèõÂæåÁöÑÁõÆÈåÑË∑ØÂæë
```

### üîß Ê∏¨Ë©¶ÂíåÈñãÁôºÂïèÈ°å

**Ê∏¨Ë©¶Áí∞Â¢ÉÈÖçÁΩÆ**:
- ‰ΩøÁî® `GMAN_CONFIG` Áí∞Â¢ÉËÆäÈáèÊåáÂÆöÊ∏¨Ë©¶ÈÖçÁΩÆÊñá‰ª∂
- ÂâµÂª∫Ëá®ÊôÇ Git ÂÄâÂ∫´ÈÄ≤Ë°åÊ∏¨Ë©¶

**Ë™øË©¶ÊäÄÂ∑ß**:
- ‰ΩøÁî® `gman --config /path/to/test/config.yml` ÊåáÂÆöÈÖçÁΩÆ
- Ê™¢Êü• `~/.config/gman/config.yml` Êñá‰ª∂ÂÖßÂÆπ
- ‰ΩøÁî® `gman list` Á¢∫Ë™çÂÄâÂ∫´ÈÖçÁΩÆÊ≠£Á¢∫